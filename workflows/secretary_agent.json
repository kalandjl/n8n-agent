{"nodes":[{"parameters":{"httpMethod":"POST","path":"secretary-agent","responseMode":"responseNode","options":{},"notes":"Main webhook endpoint that receives either chat messages or voice input. Expects JSON payload with 'type' (chat/voice), 'content' (text/audio), and optional 'user_id' field."},"id":"webhook-trigger","name":"Secretary Agent Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[200,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"{{ $json.type }}","rightValue":"voice","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"notes":"Determines if the input is voice or chat based on the 'type' field in the webhook payload."},"id":"input-type-check","name":"Check Input Type","type":"n8n-nodes-base.if","typeVersion":2,"position":[400,300]},{"parameters":{"model":"whisper-1","options":{"response_format":"text","language":"en"},"binaryPropertyName":"audio","notes":"Transcribes voice input to text using OpenAI Whisper. Expects audio file in binary format from webhook payload.","continueOnError":true},"id":"voice-transcription","name":"Transcribe Voice Input","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1,"position":[600,200]},{"parameters":{"values":{"string":[{"name":"transcribed_text","value":"{{ $json.text }}"},{"name":"input_type","value":"voice"},{"name":"user_id","value":"{{ $('Secretary Agent Webhook').item.json.user_id }}"}]},"notes":"Sets the transcribed text and maintains input type information for downstream processing.","continueOnError":false},"id":"set-voice-data","name":"Set Voice Data","type":"n8n-nodes-base.set","typeVersion":3,"position":[800,200]},{"parameters":{"values":{"string":[{"name":"transcribed_text","value":"{{ $('Secretary Agent Webhook').item.json.content }}"},{"name":"input_type","value":"chat"},{"name":"user_id","value":"{{ $('Secretary Agent Webhook').item.json.user_id }}"}]},"notes":"Sets the chat text and maintains input type information for downstream processing.","continueOnError":false},"id":"set-chat-data","name":"Set Chat Data","type":"n8n-nodes-base.set","typeVersion":3,"position":[600,400]},{"parameters":{"mode":"combine","combinationMode":"mergeByPosition","options":{},"notes":"Merges both voice and chat processing paths back together to continue with unified processing."},"id":"merge-inputs","name":"Merge Input Types","type":"n8n-nodes-base.merge","typeVersion":2,"position":[1000,300]},{"parameters":{"model":"gpt-4","messages":{"messageType":"multipleMessages","values":[{"role":"system","content":"You are an intelligent secretary assistant. Analyze the user's request and determine the intent. Classify the intent as one of: SCHEDULE, RESCHEDULE, CANCEL, QUERY_CALENDAR, GENERAL_QUESTION, EMAIL_SEARCH, or WEATHER. Also extract any relevant entities like dates, times, event names, or search terms. Respond in JSON format: {\"intent\": \"INTENT_TYPE\", \"entities\": {\"date\": \"extracted_date\", \"time\": \"extracted_time\", \"event_name\": \"event_title\", \"search_terms\": \"email_search_terms\"}, \"requires_gmail_context\": true/false, \"confidence\": 0.9}"},{"role":"user","content":"{{ $json.transcribed_text }}"}]},"options":{"temperature":0.3},"notes":"Analyzes user intent using GPT-4 to determine what action to take. Returns structured JSON with intent classification and extracted entities.","continueOnError":true},"id":"intent-analysis","name":"Analyze Intent","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1,"position":[1200,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"leftValue":"{{ $json.requires_gmail_context }}","rightValue":"true","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"notes":"Checks if the intent analysis determined that Gmail context is needed for better response generation."},"id":"check-gmail-needed","name":"Check if Gmail Context Needed","type":"n8n-nodes-base.if","typeVersion":2,"position":[1400,300]},{"parameters":{"q":"{{ $('Analyze Intent').item.json.entities.search_terms || $('Merge Input Types').item.json.transcribed_text }}","maxResults":10,"format":"full","options":{},"notes":"Searches Gmail for relevant emails based on extracted search terms or the full user query. Limited to 10 results for processing efficiency.","continueOnError":true},"id":"gmail-search","name":"Search Gmail","type":"n8n-nodes-base.gmail","typeVersion":2,"position":[1600,200]},{"parameters":{"mode":"combine","combinationMode":"mergeByPosition","options":{},"notes":"Merges the Gmail search results path with the no-Gmail-needed path to continue unified processing."},"id":"merge-gmail-context","name":"Merge Gmail Context","type":"n8n-nodes-base.merge","typeVersion":2,"position":[1800,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"{{ $('Analyze Intent').item.json.intent }}","rightValue":"SCHEDULE","operator":{"type":"string","operation":"equals"}},{"leftValue":"{{ $('Analyze Intent').item.json.intent }}","rightValue":"RESCHEDULE","operator":{"type":"string","operation":"equals"}},{"leftValue":"{{ $('Analyze Intent').item.json.intent }}","rightValue":"CANCEL","operator":{"type":"string","operation":"equals"}},{"leftValue":"{{ $('Analyze Intent').item.json.intent }}","rightValue":"QUERY_CALENDAR","operator":{"type":"string","operation":"equals"}}],"combinator":"or"},"notes":"Routes calendar-related intents (SCHEDULE, RESCHEDULE, CANCEL, QUERY_CALENDAR) to calendar processing branch."},"id":"calendar-intent-router","name":"Route Calendar Intents","type":"n8n-nodes-base.if","typeVersion":2,"position":[2000,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"{{ $('Analyze Intent').item.json.intent }}","rightValue":"SCHEDULE","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"notes":"Specifically routes SCHEDULE intent to calendar event creation."},"id":"schedule-check","name":"Check Schedule Intent","type":"n8n-nodes-base.if","typeVersion":2,"position":[2200,200]},{"parameters":{"calendarId":"primary","summary":"{{ $('Analyze Intent').item.json.entities.event_name || 'New Appointment' }}","start":{"dateTime":"{{ $('Analyze Intent').item.json.entities.date }}T{{ $('Analyze Intent').item.json.entities.time || '09:00:00' }}","timeZone":"{{ ENV.DEFAULT_TIMEZONE || 'America/New_York' }}"},"end":{"dateTime":"{{ $('Analyze Intent').item.json.entities.date }}T{{ moment($('Analyze Intent').item.json.entities.time || '09:00:00', 'HH:mm:ss').add(1, 'hour').format('HH:mm:ss') }}","timeZone":"{{ ENV.DEFAULT_TIMEZONE || 'America/New_York' }}"},"description":"Event created by Secretary Agent","options":{},"notes":"Creates a new calendar event using extracted entities. Default duration is 1 hour if no end time specified.","continueOnError":true},"id":"create-calendar-event","name":"Create Calendar Event","type":"n8n-nodes-base.googleCalendar","typeVersion":2,"position":[2400,150]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"{{ $('Analyze Intent').item.json.intent }}","rightValue":"QUERY_CALENDAR","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"notes":"Routes QUERY_CALENDAR intent to calendar listing functionality."},"id":"query-calendar-check","name":"Check Query Calendar Intent","type":"n8n-nodes-base.if","typeVersion":2,"position":[2200,300]},{"parameters":{"calendarId":"primary","timeMin":"{{ moment().startOf('day').toISOString() }}","timeMax":"{{ moment().add(7, 'days').endOf('day').toISOString() }}","maxResults":20,"singleEvents":true,"orderBy":"startTime","options":{},"notes":"Retrieves upcoming calendar events for the next 7 days. Limited to 20 results for manageable processing.","continueOnError":true},"id":"list-calendar-events","name":"List Calendar Events","type":"n8n-nodes-base.googleCalendar","typeVersion":2,"position":[2400,300]},{"parameters":{"mode":"combine","combinationMode":"mergeByPosition","options":{},"notes":"Merges all calendar operation results back together for unified response generation."},"id":"merge-calendar-results","name":"Merge Calendar Results","type":"n8n-nodes-base.merge","typeVersion":2,"position":[2600,250]},{"parameters":{"model":"gpt-4","messages":{"messageType":"multipleMessages","values":[{"role":"system","content":"You are a helpful secretary assistant. Based on the user's original request, intent analysis, and any calendar/email context provided, generate an appropriate response. Be professional, concise, and helpful. Include specific details from calendar events or email context when relevant. Company information will be provided in context when available."},{"role":"user","content":"Original request: {{ $('Merge Input Types').item.json.transcribed_text }}\n\nIntent Analysis: {{ $('Analyze Intent').item.json }}\n\nCalendar Context: {{ $json }}\n\nEmail Context: {{ $('Search Gmail').item.json || 'No email context available' }}\n\nCompany Info: {{ ENV.COMPANY_INFO_TEXT || 'Company information not configured' }}"}]},"options":{"temperature":0.7},"notes":"Generates the final response using all available context including intent, calendar data, email context, and company information.","continueOnError":true},"id":"generate-response","name":"Generate Response","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1,"position":[2800,300]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"{{ $('Merge Input Types').item.json.input_type }}","rightValue":"voice","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"notes":"Determines output format based on original input type - voice input gets voice response, chat gets text response."},"id":"output-type-check","name":"Check Output Type","type":"n8n-nodes-base.if","typeVersion":2,"position":[3000,300]},{"parameters":{"model":"tts-1","voice":"alloy","input":"{{ $('Generate Response').item.json.content || $('Generate Response').item.json.message }}","response_format":"mp3","options":{},"notes":"Converts text response to speech for voice input requests using OpenAI TTS.","continueOnError":true},"id":"text-to-speech","name":"Convert to Speech","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1,"position":[3200,200]},{"parameters":{"values":{"string":[{"name":"response_type","value":"voice"},{"name":"audio_response","value":"{{ $json }}"},{"name":"text_response","value":"{{ $('Generate Response').item.json.content || $('Generate Response').item.json.message }}"}]},"notes":"Packages voice response with both audio and text versions for complete response.","continueOnError":false},"id":"set-voice-response","name":"Set Voice Response","type":"n8n-nodes-base.set","typeVersion":3,"position":[3400,200]},{"parameters":{"values":{"string":[{"name":"response_type","value":"text"},{"name":"text_response","value":"{{ $('Generate Response').item.json.content || $('Generate Response').item.json.message }}"}]},"notes":"Packages text response for chat input requests.","continueOnError":false},"id":"set-text-response","name":"Set Text Response","type":"n8n-nodes-base.set","typeVersion":3,"position":[3200,400]},{"parameters":{"mode":"combine","combinationMode":"mergeByPosition","options":{},"notes":"Merges both response types (voice and text) for final output preparation."},"id":"merge-responses","name":"Merge Response Types","type":"n8n-nodes-base.merge","typeVersion":2,"position":[3600,300]},{"parameters":{"respondWith":"json","responseBody":"{{ $json }}","options":{},"notes":"Returns the final response to the webhook caller with appropriate format (text or voice) based on input type."},"id":"webhook-response","name":"Send Response","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[3800,300]},{"parameters":{"notes":"Error handling path for voice transcription failures. Provides fallback response when speech-to-text fails.","continueOnError":false},"id":"transcription-error","name":"Transcription Error Handler","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[800,100]},{"parameters":{"values":{"string":[{"name":"response_type","value":"text"},{"name":"text_response","value":"I'm sorry, I couldn't understand the audio. Please try again or send a text message instead."},{"name":"error","value":"transcription_failed"}]},"notes":"Sets error response when voice transcription fails.","continueOnError":false},"id":"set-transcription-error","name":"Set Transcription Error Response","type":"n8n-nodes-base.set","typeVersion":3,"position":[1000,100]},{"parameters":{"notes":"Error handling path for intent analysis failures. Continues workflow with fallback processing.","continueOnError":false},"id":"intent-error","name":"Intent Analysis Error Handler","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1400,100]},{"parameters":{"values":{"string":[{"name":"intent","value":"GENERAL_QUESTION"},{"name":"entities","value":"{}"},{"name":"requires_gmail_context","value":"false"},{"name":"confidence","value":"0.1"}]},"notes":"Provides fallback intent classification when AI analysis fails.","continueOnError":false},"id":"set-fallback-intent","name":"Set Fallback Intent","type":"n8n-nodes-base.set","typeVersion":3,"position":[1600,100]},{"parameters":{"notes":"Error handling path for Gmail search failures. Continues workflow without email context.","continueOnError":false},"id":"gmail-error","name":"Gmail Search Error Handler","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1800,100]},{"parameters":{"notes":"Error handling path for calendar operation failures. Continues workflow with error notification.","continueOnError":false},"id":"calendar-error","name":"Calendar Error Handler","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2600,100]},{"parameters":{"values":{"string":[{"name":"calendar_error","value":"true"},{"name":"error_message","value":"Calendar operation failed. Please try again or contact support."}]},"notes":"Sets error response for calendar operation failures.","continueOnError":false},"id":"set-calendar-error","name":"Set Calendar Error Response","type":"n8n-nodes-base.set","typeVersion":3,"position":[2800,100]},{"parameters":{"notes":"Error handling path for response generation failures. Provides generic fallback response.","continueOnError":false},"id":"response-error","name":"Response Generation Error Handler","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[3000,100]},{"parameters":{"values":{"string":[{"name":"response_type","value":"text"},{"name":"text_response","value":"I'm experiencing technical difficulties. Please try again later."},{"name":"error","value":"response_generation_failed"}]},"notes":"Provides fallback response when AI response generation fails.","continueOnError":false},"id":"set-response-error","name":"Set Response Error","type":"n8n-nodes-base.set","typeVersion":3,"position":[3200,100]},{"parameters":{"notes":"Error handling path for text-to-speech failures. Falls back to text response.","continueOnError":false},"id":"tts-error","name":"TTS Error Handler","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[3400,100]},{"parameters":{"values":{"string":[{"name":"response_type","value":"text"},{"name":"text_response","value":"{{ $('Generate Response').item.json.content || $('Generate Response').item.json.message }}"},{"name":"tts_error","value":"true"}]},"notes":"Falls back to text response when text-to-speech conversion fails.","continueOnError":false},"id":"set-tts-fallback","name":"Set TTS Fallback Response","type":"n8n-nodes-base.set","typeVersion":3,"position":[3600,100]}],"connections":{"webhook-trigger":{"main":[[{"node":"input-type-check","type":"main","index":0}]]},"input-type-check":{"main":[[{"node":"voice-transcription","type":"main","index":0}],[{"node":"set-chat-data","type":"main","index":0}]]},"voice-transcription":{"main":[[{"node":"set-voice-data","type":"main","index":0}]],"error":[[{"node":"transcription-error","type":"main","index":0}]]},"set-voice-data":{"main":[[{"node":"merge-inputs","type":"main","index":0}]]},"set-chat-data":{"main":[[{"node":"merge-inputs","type":"main","index":1}]]},"merge-inputs":{"main":[[{"node":"intent-analysis","type":"main","index":0}]]},"intent-analysis":{"main":[[{"node":"check-gmail-needed","type":"main","index":0}]],"error":[[{"node":"intent-error","type":"main","index":0}]]},"check-gmail-needed":{"main":[[{"node":"gmail-search","type":"main","index":0}],[{"node":"merge-gmail-context","type":"main","index":1}]]},"gmail-search":{"main":[[{"node":"merge-gmail-context","type":"main","index":0}]],"error":[[{"node":"gmail-error","type":"main","index":0}]]},"merge-gmail-context":{"main":[[{"node":"calendar-intent-router","type":"main","index":0}]]},"calendar-intent-router":{"main":[[{"node":"schedule-check","type":"main","index":0}],[{"node":"generate-response","type":"main","index":0}]]},"schedule-check":{"main":[[{"node":"create-calendar-event","type":"main","index":0}],[{"node":"query-calendar-check","type":"main","index":0}]]},"create-calendar-event":{"main":[[{"node":"merge-calendar-results","type":"main","index":0}]],"error":[[{"node":"calendar-error","type":"main","index":0}]]},"query-calendar-check":{"main":[[{"node":"list-calendar-events","type":"main","index":0}],[{"node":"merge-calendar-results","type":"main","index":1}]]},"list-calendar-events":{"main":[[{"node":"merge-calendar-results","type":"main","index":1}]],"error":[[{"node":"calendar-error","type":"main","index":0}]]},"merge-calendar-results":{"main":[[{"node":"generate-response","type":"main","index":0}]]},"generate-response":{"main":[[{"node":"output-type-check","type":"main","index":0}]],"error":[[{"node":"response-error","type":"main","index":0}]]},"output-type-check":{"main":[[{"node":"text-to-speech","type":"main","index":0}],[{"node":"set-text-response","type":"main","index":0}]]},"text-to-speech":{"main":[[{"node":"set-voice-response","type":"main","index":0}]],"error":[[{"node":"tts-error","type":"main","index":0}]]},"set-voice-response":{"main":[[{"node":"merge-responses","type":"main","index":0}]]},"set-text-response":{"main":[[{"node":"merge-responses","type":"main","index":1}]]},"merge-responses":{"main":[[{"node":"webhook-response","type":"main","index":0}]]},"transcription-error":{"main":[[{"node":"set-transcription-error","type":"main","index":0}]]},"set-transcription-error":{"main":[[{"node":"webhook-response","type":"main","index":0}]]},"intent-error":{"main":[[{"node":"set-fallback-intent","type":"main","index":0}]]},"set-fallback-intent":{"main":[[{"node":"check-gmail-needed","type":"main","index":0}]]},"gmail-error":{"main":[[{"node":"merge-gmail-context","type":"main","index":0}]]},"calendar-error":{"main":[[{"node":"set-calendar-error","type":"main","index":0}]]},"set-calendar-error":{"main":[[{"node":"generate-response","type":"main","index":0}]]},"response-error":{"main":[[{"node":"set-response-error","type":"main","index":0}]]},"set-response-error":{"main":[[{"node":"output-type-check","type":"main","index":0}]]},"tts-error":{"main":[[{"node":"set-tts-fallback","type":"main","index":0}]]},"set-tts-fallback":{"main":[[{"node":"merge-responses","type":"main","index":0}]]}},"name":"Comprehensive Secretary Agent","description":"A comprehensive secretary agent that handles both chat and voice inputs, providing intelligent responses for scheduling, calendar management, email search, and general company questions. Features robust error handling, intent analysis, and context-aware responses. Requires configuration of environment variables: ENV.DEFAULT_TIMEZONE, ENV.COMPANY_INFO_TEXT, and proper OAuth credentials for Google Calendar and Gmail APIs.","active":false,"version":1}